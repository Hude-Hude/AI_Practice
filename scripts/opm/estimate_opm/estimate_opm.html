<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Structural Estimation for Static Oligopoly Pricing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="estimate_opm_files/libs/clipboard/clipboard.min.js"></script>
<script src="estimate_opm_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="estimate_opm_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="estimate_opm_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="estimate_opm_files/libs/quarto-html/popper.min.js"></script>
<script src="estimate_opm_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="estimate_opm_files/libs/quarto-html/anchor.min.js"></script>
<link href="estimate_opm_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="estimate_opm_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="estimate_opm_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="estimate_opm_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="estimate_opm_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#instruction" id="toc-instruction" class="nav-link active" data-scroll-target="#instruction">Instruction</a>
  <ul class="collapse">
  <li><a href="#goal" id="toc-goal" class="nav-link" data-scroll-target="#goal">Goal</a></li>
  <li><a href="#required-components" id="toc-required-components" class="nav-link" data-scroll-target="#required-components">Required Components</a></li>
  <li><a href="#deliverable" id="toc-deliverable" class="nav-link" data-scroll-target="#deliverable">Deliverable</a></li>
  </ul></li>
  <li><a href="#estimation-design" id="toc-estimation-design" class="nav-link" data-scroll-target="#estimation-design">Estimation Design</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#model-structure" id="toc-model-structure" class="nav-link" data-scroll-target="#model-structure">Model Structure</a></li>
  <li><a href="#identification-strategy" id="toc-identification-strategy" class="nav-link" data-scroll-target="#identification-strategy">Identification Strategy</a></li>
  <li><a href="#two-step-estimation-procedure" id="toc-two-step-estimation-procedure" class="nav-link" data-scroll-target="#two-step-estimation-procedure">Two-Step Estimation Procedure</a></li>
  <li><a href="#algorithm-pseudocode" id="toc-algorithm-pseudocode" class="nav-link" data-scroll-target="#algorithm-pseudocode">Algorithm: Pseudocode</a></li>
  <li><a href="#complete-estimation-algorithm" id="toc-complete-estimation-algorithm" class="nav-link" data-scroll-target="#complete-estimation-algorithm">Complete Estimation Algorithm</a></li>
  <li><a href="#diagnostics-and-validation" id="toc-diagnostics-and-validation" class="nav-link" data-scroll-target="#diagnostics-and-validation">Diagnostics and Validation</a></li>
  <li><a href="#outputs" id="toc-outputs" class="nav-link" data-scroll-target="#outputs">Outputs</a></li>
  </ul></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#load-simulated-data" id="toc-load-simulated-data" class="nav-link" data-scroll-target="#load-simulated-data">Load Simulated Data</a></li>
  <li><a href="#run-estimation-for-all-scenarios" id="toc-run-estimation-for-all-scenarios" class="nav-link" data-scroll-target="#run-estimation-for-all-scenarios">Run Estimation for All Scenarios</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#parameter-recovery-summary" id="toc-parameter-recovery-summary" class="nav-link" data-scroll-target="#parameter-recovery-summary">Parameter Recovery Summary</a></li>
  <li><a href="#shock-recovery-summary" id="toc-shock-recovery-summary" class="nav-link" data-scroll-target="#shock-recovery-summary">Shock Recovery Summary</a></li>
  <li><a href="#parameter-recovery-visualization" id="toc-parameter-recovery-visualization" class="nav-link" data-scroll-target="#parameter-recovery-visualization">Parameter Recovery Visualization</a></li>
  <li><a href="#shock-recovery-visualization" id="toc-shock-recovery-visualization" class="nav-link" data-scroll-target="#shock-recovery-visualization">Shock Recovery Visualization</a></li>
  </ul></li>
  <li><a href="#diagnostics" id="toc-diagnostics" class="nav-link" data-scroll-target="#diagnostics">Diagnostics</a>
  <ul class="collapse">
  <li><a href="#gmm-objective-surface" id="toc-gmm-objective-surface" class="nav-link" data-scroll-target="#gmm-objective-surface">GMM Objective Surface</a></li>
  <li><a href="#economic-sanity-checks" id="toc-economic-sanity-checks" class="nav-link" data-scroll-target="#economic-sanity-checks">Economic Sanity Checks</a></li>
  <li><a href="#negative-cost-diagnosis" id="toc-negative-cost-diagnosis" class="nav-link" data-scroll-target="#negative-cost-diagnosis">Negative Cost Diagnosis</a></li>
  <li><a href="#shock-distribution-comparison" id="toc-shock-distribution-comparison" class="nav-link" data-scroll-target="#shock-distribution-comparison">Shock Distribution Comparison</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Structural Estimation for Static Oligopoly Pricing</h1>
<p class="subtitle lead">Demand Estimation (GMM) and Cost Recovery</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="instruction" class="level2">
<h2 class="anchored" data-anchor-id="instruction">Instruction</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Original Problem Statement
</div>
</div>
<div class="callout-body-container callout-body">
<p>This section contains the original instructional content defining the estimation exercise.</p>
</div>
</div>
<section id="goal" class="level3">
<h3 class="anchored" data-anchor-id="goal">Goal</h3>
<p>Define the estimation exercise that mirrors <code>scripts/estimate_mdp/estimate_mdp.qmd</code>, but now focuses on recovering demand and cost primitives of the static oligopoly pricing model using the simulated market outcomes generated in <code>scripts/opm/simulate_opm/simulate_opm.qmd</code>.</p>
</section>
<section id="required-components" class="level3">
<h3 class="anchored" data-anchor-id="required-components">Required Components</h3>
<ol type="1">
<li><strong>Data ingestion</strong>: Outline how trainees should load simulated datasets (prices, quantities, instruments, cost shifters) and configuration metadata.</li>
<li><strong>Estimation strategy</strong>: Specify a two-step procedure—(i) back out demand shocks from the share equations and estimate demand parameters using GMM, (ii) back out marginal costs from the first-order conditions and estimate the cost parameters by a regression.</li>
<li><strong>Model validation</strong>: Require fit diagnostics, comparison between recovered and true shocks in demand and cost. The shape of the GMM objective function around the true parameter along each dimension.</li>
</ol>
</section>
<section id="deliverable" class="level3">
<h3 class="anchored" data-anchor-id="deliverable">Deliverable</h3>
<p>An executable Quarto report (to be implemented by juniors) and rendered html report that mirrors the flow of the MDP estimator, but focuses solely on static oligopoly market simulations. Juniors will fill in all code, figures, and tables.</p>
<hr>
</section>
</section>
<section id="estimation-design" class="level2">
<h2 class="anchored" data-anchor-id="estimation-design">Estimation Design</h2>
<section id="overview" class="level3">
<h3 class="anchored" data-anchor-id="overview">Overview</h3>
<p>The estimation problem is to recover the structural parameters of the oligopoly pricing model from observed market data. We observe:</p>
<ul>
<li><strong>Prices</strong>: <span class="math inline">\(p_{jm}\)</span> for product <span class="math inline">\(j\)</span> in market <span class="math inline">\(m\)</span></li>
<li><strong>Market shares</strong>: <span class="math inline">\(s_{jm}\)</span> for product <span class="math inline">\(j\)</span> in market <span class="math inline">\(m\)</span></li>
<li><strong>Product characteristics</strong>: <span class="math inline">\(\bar{\delta}_j\)</span> (baseline mean utilities)</li>
<li><strong>Cost shifters</strong>: <span class="math inline">\(\bar{c}_j\)</span> (baseline marginal costs)</li>
</ul>
<p>We seek to recover:</p>
<ul>
<li><strong>Demand parameter</strong>: <span class="math inline">\(\alpha\)</span> (price sensitivity)</li>
<li><strong>Demand shocks</strong>: <span class="math inline">\(\xi_{jm}\)</span> (unobserved product quality)</li>
<li><strong>Cost shocks</strong>: <span class="math inline">\(\omega_{jm}\)</span> (unobserved cost variation)</li>
</ul>
</section>
<section id="model-structure" class="level3">
<h3 class="anchored" data-anchor-id="model-structure">Model Structure</h3>
<section id="demand-side" class="level4">
<h4 class="anchored" data-anchor-id="demand-side">Demand Side</h4>
<p>The logit demand model gives market shares: <span class="math display">\[
s_{jm} = \frac{\exp(\delta_{jm} - \alpha p_{jm})}{1 + \sum_{k=1}^{J} \exp(\delta_{km} - \alpha p_{km})}
\]</span></p>
<p>where the mean utility decomposes as: <span class="math display">\[
\delta_{jm} = \bar{\delta}_j + \xi_{jm}
\]</span></p>
<ul>
<li><span class="math inline">\(\bar{\delta}_j\)</span>: baseline mean utility (observed/known from config)</li>
<li><span class="math inline">\(\xi_{jm}\)</span>: demand shock (unobserved, to be recovered)</li>
</ul>
</section>
<section id="supply-side" class="level4">
<h4 class="anchored" data-anchor-id="supply-side">Supply Side</h4>
<p>From profit maximization, the first-order conditions give: <span class="math display">\[
p_{jm} = c_{jm} + \eta_{jm}
\]</span></p>
<p>where: <span class="math display">\[
\eta_{jm} = \frac{1}{\alpha(1 - s_{jm})}
\]</span></p>
<p>Marginal costs decompose as: <span class="math display">\[
c_{jm} = \bar{c}_j + \omega_{jm}
\]</span></p>
<ul>
<li><span class="math inline">\(\bar{c}_j\)</span>: baseline marginal cost (observed/known from config)</li>
<li><span class="math inline">\(\omega_{jm}\)</span>: cost shock (unobserved, to be recovered)</li>
</ul>
</section>
</section>
<section id="identification-strategy" class="level3">
<h3 class="anchored" data-anchor-id="identification-strategy">Identification Strategy</h3>
<section id="the-endogeneity-problem" class="level4">
<h4 class="anchored" data-anchor-id="the-endogeneity-problem">The Endogeneity Problem</h4>
<p>Prices are <strong>endogenous</strong>: firms observe demand shocks <span class="math inline">\(\xi_{jm}\)</span> and set prices accordingly. This creates correlation: <span class="math display">\[
\text{Cov}(p_{jm}, \xi_{jm}) \neq 0
\]</span></p>
<p>Naive regression of shares on prices yields biased estimates of <span class="math inline">\(\alpha\)</span>.</p>
</section>
<section id="instrumental-variables" class="level4">
<h4 class="anchored" data-anchor-id="instrumental-variables">Instrumental Variables</h4>
<p>We need instruments <span class="math inline">\(Z_{jm}\)</span> that satisfy:</p>
<ol type="1">
<li><strong>Relevance</strong>: <span class="math inline">\(\text{Cov}(Z_{jm}, p_{jm}) \neq 0\)</span></li>
<li><strong>Exogeneity</strong>: <span class="math inline">\(\text{Cov}(Z_{jm}, \xi_{jm}) = 0\)</span></li>
</ol>
<p><strong>BLP-style instruments</strong> (characteristics of competing products):</p>
<ul>
<li>Sum of competitors’ characteristics: <span class="math inline">\(Z_{jm}^{BLP} = \sum_{k \neq j} x_{km}\)</span></li>
<li>Rationale: Other products’ characteristics affect equilibrium prices (relevance) but are uncorrelated with own demand shocks (exogeneity)</li>
</ul>
<p><strong>Cost shifters</strong> (excluded from demand):</p>
<ul>
<li>Variables that affect costs but not utility directly</li>
<li>E.g., input prices, distance to suppliers</li>
</ul>
</section>
<section id="our-setting-simulation" class="level4">
<h4 class="anchored" data-anchor-id="our-setting-simulation">Our Setting (Simulation)</h4>
<p>In our simulation:</p>
<ul>
<li>We <strong>know</strong> the true <span class="math inline">\(\alpha\)</span> (can verify recovery)</li>
<li>We <strong>know</strong> the true shocks <span class="math inline">\(\xi_{jm}, \omega_{jm}\)</span> (can validate)</li>
<li>Cost shocks <span class="math inline">\(\omega_{jm}\)</span> serve as natural instruments (affect prices, uncorrelated with demand shocks by construction)</li>
</ul>
</section>
</section>
<section id="two-step-estimation-procedure" class="level3">
<h3 class="anchored" data-anchor-id="two-step-estimation-procedure">Two-Step Estimation Procedure</h3>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                   TWO-STEP ESTIMATION                           │
├─────────────────────────────────────────────────────────────────┤
│  STEP 1: Demand Estimation (GMM)                                │
│          • Berry inversion: recover δ from shares               │
│          • Compute demand shocks: ξ = δ - δ̄                     │
│          • GMM: find α that makes E[Z'ξ] = 0                    │
├─────────────────────────────────────────────────────────────────┤
│  STEP 2: Cost Recovery                                          │
│          • Use estimated α̂ to compute markups                   │
│          • Back out costs: c = p - η                            │
│          • Recover cost shocks: ω = c - c̄                       │
└─────────────────────────────────────────────────────────────────┘</code></pre>
</section>
<section id="algorithm-pseudocode" class="level3">
<h3 class="anchored" data-anchor-id="algorithm-pseudocode">Algorithm: Pseudocode</h3>
<section id="step-1-berry-inversion" class="level4">
<h4 class="anchored" data-anchor-id="step-1-berry-inversion">Step 1: Berry Inversion</h4>
<pre><code>FUNCTION BERRY_INVERSION(shares, outside_share):
    """
    Invert market shares to recover mean utilities.
    
    For logit demand without random coefficients:
        ln(s_j) - ln(s_0) = δ_j - α*p_j
    
    Since we want δ_j (including the -αp term absorbed):
        δ_j = ln(s_j) - ln(s_0)
    
    This is the "observed" mean utility that rationalizes shares.
    """
    
    INPUT:
      shares       : Matrix[M, J]    # Market shares s_jm
      outside_share: Vector[M]       # Outside option share s_0m = 1 - Σ_j s_jm
    
    OUTPUT:
      delta        : Matrix[M, J]    # Mean utilities δ_jm
    
    PROCEDURE:
      FOR m = 1 TO M:
        s_0m = outside_share[m]
        FOR j = 1 TO J:
          delta[m, j] = ln(shares[m, j]) - ln(s_0m)
      
      RETURN delta</code></pre>
</section>
<section id="step-1-gmm-estimation-of-α" class="level4">
<h4 class="anchored" data-anchor-id="step-1-gmm-estimation-of-α">Step 1: GMM Estimation of α</h4>
<pre><code>FUNCTION ESTIMATE_ALPHA_GMM(prices, shares, delta_bar, instruments):
    """
    Estimate price sensitivity α via GMM.
    
    Model: δ_jm = δ̄_j + ξ_jm  (mean utility)
           δ_jm^obs = ln(s_jm) - ln(s_0m) = δ̄_j - α*p_jm + ξ_jm
    
    Rearranging:
           ξ_jm = δ_jm^obs - δ̄_j + α*p_jm
    
    Moment condition: E[Z_jm * ξ_jm] = 0
    
    GMM objective: Q(α) = ξ(α)' Z (Z'Z)^{-1} Z' ξ(α)
    """
    
    INPUT:
      prices     : Matrix[M, J]    # Observed prices p_jm
      shares     : Matrix[M, J]    # Observed shares s_jm
      delta_bar  : Vector[J]       # Baseline mean utilities δ̄_j
      instruments: Matrix[M*J, K]  # Instruments Z
    
    OUTPUT:
      alpha_hat  : Scalar          # Estimated price sensitivity
      xi_hat     : Matrix[M, J]    # Recovered demand shocks
    
    PROCEDURE:
      # Berry inversion
      outside_share = 1 - sum(shares, axis=1)
      delta_obs = BERRY_INVERSION(shares, outside_share)
      
      # GMM objective function
      FUNCTION gmm_objective(alpha):
        # Compute demand shocks
        xi = delta_obs - delta_bar + alpha * prices
        xi_vec = xi.flatten()
        
        # Moment conditions
        moments = Z' * xi_vec
        
        # GMM criterion (2-step efficient: W = (Z'Z)^{-1})
        W = inv(Z' * Z)
        Q = moments' * W * moments
        
        RETURN Q
      
      # Minimize GMM objective
      alpha_hat = argmin_{alpha} gmm_objective(alpha)
      
      # Recover demand shocks at estimated α
      xi_hat = delta_obs - delta_bar + alpha_hat * prices
      
      RETURN alpha_hat, xi_hat</code></pre>
</section>
<section id="step-2-cost-recovery" class="level4">
<h4 class="anchored" data-anchor-id="step-2-cost-recovery">Step 2: Cost Recovery</h4>
<pre><code>FUNCTION RECOVER_COSTS(prices, shares, alpha_hat, costs_bar, ownership):
    """
    Back out marginal costs from FOC.
    
    FOC: p_j = c_j + η_j
    where η_j = 1/(α(1-s_j)) for single-product firms
    
    Therefore: c_j = p_j - η_j
    Cost shock: ω_j = c_j - c̄_j
    """
    
    INPUT:
      prices    : Matrix[M, J]    # Observed prices
      shares    : Matrix[M, J]    # Observed shares
      alpha_hat : Scalar          # Estimated α
      costs_bar : Vector[J]       # Baseline costs c̄_j
      ownership : Matrix[J, J]    # Ownership matrix Ω
    
    OUTPUT:
      costs_hat : Matrix[M, J]    # Recovered marginal costs
      omega_hat : Matrix[M, J]    # Recovered cost shocks
      markups   : Matrix[M, J]    # Implied markups
    
    PROCEDURE:
      FOR m = 1 TO M:
        # Compute markups from FOC
        FOR j = 1 TO J:
          markups[m, j] = 1 / (alpha_hat * (1 - shares[m, j]))
        
        # Back out costs
        costs_hat[m] = prices[m] - markups[m]
        
        # Recover cost shocks
        omega_hat[m] = costs_hat[m] - costs_bar
      
      RETURN costs_hat, omega_hat, markups</code></pre>
</section>
</section>
<section id="complete-estimation-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="complete-estimation-algorithm">Complete Estimation Algorithm</h3>
<pre><code>ALGORITHM: ESTIMATE_OPM
────────────────────────
INPUT:
  prices     : Matrix[M, J]    # Observed equilibrium prices
  shares     : Matrix[M, J]    # Observed market shares
  delta_bar  : Vector[J]       # Baseline mean utilities (from config)
  costs_bar  : Vector[J]       # Baseline marginal costs (from config)
  ownership  : Matrix[J, J]    # Ownership structure (from config)
  instruments: Matrix[M*J, K]  # Instruments for GMM

OUTPUT:
  EstimationResult containing:
    - alpha_hat : Scalar         # Estimated price sensitivity
    - xi_hat    : Matrix[M, J]   # Recovered demand shocks
    - omega_hat : Matrix[M, J]   # Recovered cost shocks
    - costs_hat : Matrix[M, J]   # Recovered marginal costs

PROCEDURE:
  # ─────────────────────────────────────────────
  # STEP 1: DEMAND ESTIMATION (GMM)
  # ─────────────────────────────────────────────
  
  # 1a. Berry inversion
  outside_share = 1 - rowsum(shares)
  delta_obs = ln(shares) - ln(outside_share)  # element-wise
  
  # 1b. GMM estimation
  alpha_hat, xi_hat = ESTIMATE_ALPHA_GMM(
      prices, shares, delta_bar, instruments
  )
  
  # ─────────────────────────────────────────────
  # STEP 2: COST RECOVERY
  # ─────────────────────────────────────────────
  
  costs_hat, omega_hat, markups = RECOVER_COSTS(
      prices, shares, alpha_hat, costs_bar, ownership
  )
  
  RETURN EstimationResult(alpha_hat, xi_hat, omega_hat, costs_hat)</code></pre>
</section>
<section id="diagnostics-and-validation" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics-and-validation">Diagnostics and Validation</h3>
<section id="parameter-recovery" class="level4">
<h4 class="anchored" data-anchor-id="parameter-recovery">Parameter Recovery</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Check</th>
<th>Description</th>
<th>Expected</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>α recovery</td>
<td>Compare <span class="math inline">\(\hat{\alpha}\)</span> to true <span class="math inline">\(\alpha\)</span></td>
<td>Bias &lt; 5%</td>
</tr>
<tr class="even">
<td>Standard error</td>
<td>Asymptotic SE from GMM</td>
<td>Covers true value</td>
</tr>
</tbody>
</table>
</section>
<section id="shock-recovery" class="level4">
<h4 class="anchored" data-anchor-id="shock-recovery">Shock Recovery</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 43%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Check</th>
<th>Description</th>
<th>Expected</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Demand shocks</td>
<td>Correlation(<span class="math inline">\(\hat{\xi}\)</span>, true <span class="math inline">\(\xi\)</span>)</td>
<td>&gt; 0.95</td>
</tr>
<tr class="even">
<td>Cost shocks</td>
<td>Correlation(<span class="math inline">\(\hat{\omega}\)</span>, true <span class="math inline">\(\omega\)</span>)</td>
<td>&gt; 0.99</td>
</tr>
<tr class="odd">
<td>Mean recovery</td>
<td>Mean(<span class="math inline">\(\hat{\xi}\)</span>) ≈ 0, Mean(<span class="math inline">\(\hat{\omega}\)</span>) ≈ 0</td>
<td>Near zero</td>
</tr>
</tbody>
</table>
</section>
<section id="gmm-diagnostics" class="level4">
<h4 class="anchored" data-anchor-id="gmm-diagnostics">GMM Diagnostics</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 43%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Check</th>
<th>Description</th>
<th>Expected</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>J-statistic</td>
<td>Overidentification test</td>
<td>p &gt; 0.05</td>
</tr>
<tr class="even">
<td>Objective surface</td>
<td>GMM objective around <span class="math inline">\(\hat{\alpha}\)</span></td>
<td>Clear minimum</td>
</tr>
<tr class="odd">
<td>First-stage F</td>
<td>Instrument strength</td>
<td>F &gt; 10</td>
</tr>
</tbody>
</table>
</section>
<section id="economic-validity" class="level4">
<h4 class="anchored" data-anchor-id="economic-validity">Economic Validity</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Check</th>
<th>Description</th>
<th>Expected</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Markups positive</td>
<td>All <span class="math inline">\(\hat{\eta}_{jm} &gt; 0\)</span></td>
<td>✓</td>
</tr>
<tr class="even">
<td>Costs positive</td>
<td>All <span class="math inline">\(\hat{c}_{jm} &gt; 0\)</span></td>
<td>✓</td>
</tr>
<tr class="odd">
<td>FOC satisfied</td>
<td><span class="math inline">\(p = c + \eta\)</span> holds</td>
<td>✓</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="outputs" class="level3">
<h3 class="anchored" data-anchor-id="outputs">Outputs</h3>
<p>The estimator produces:</p>
<ol type="1">
<li><strong>Parameter estimates</strong>: <span class="math inline">\(\hat{\alpha}\)</span> with standard errors</li>
<li><strong>Recovered shocks</strong>: <span class="math inline">\(\hat{\xi}_{jm}\)</span>, <span class="math inline">\(\hat{\omega}_{jm}\)</span> for all markets</li>
<li><strong>Implied costs</strong>: <span class="math inline">\(\hat{c}_{jm}\)</span> for all markets</li>
<li><strong>Diagnostics</strong>: GMM objective, J-statistic, correlation with true values</li>
</ol>
<hr>
</section>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<div id="setup" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add project paths</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>sys.path.insert(<span class="dv">0</span>, <span class="st">"../../../src"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>sys.path.insert(<span class="dv">0</span>, <span class="st">"../config_opm"</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Import OPM estimator</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> opm.estimator_opm <span class="im">import</span> (</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    estimate_opm,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    construct_cost_instruments,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    berry_inversion,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    gmm_objective,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Import configuration</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> config</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot style</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'seaborn-v0_8-whitegrid'</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">12</span>, <span class="dv">6</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'font.size'</span>] <span class="op">=</span> <span class="dv">11</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Modules loaded successfully"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Modules loaded successfully</code></pre>
</div>
</div>
</section>
<section id="load-simulated-data" class="level3">
<h3 class="anchored" data-anchor-id="load-simulated-data">Load Simulated Data</h3>
<div id="load-data" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data directory</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> Path(<span class="st">"../../../output/opm/simulate"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Scenarios to estimate</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>scenario_names <span class="op">=</span> <span class="bu">list</span>(config.SCENARIOS.keys())</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data for all scenarios</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {}</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    scenario_dir <span class="op">=</span> data_dir <span class="op">/</span> name</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load observed data</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    prices <span class="op">=</span> np.load(scenario_dir <span class="op">/</span> <span class="st">"prices.npy"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    shares <span class="op">=</span> np.load(scenario_dir <span class="op">/</span> <span class="st">"shares.npy"</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load true shocks (for validation)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    xi_true <span class="op">=</span> np.load(scenario_dir <span class="op">/</span> <span class="st">"xi_true.npy"</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    omega_true <span class="op">=</span> np.load(scenario_dir <span class="op">/</span> <span class="st">"omega_true.npy"</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load config</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(scenario_dir <span class="op">/</span> <span class="st">"config.json"</span>) <span class="im">as</span> f:</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        cfg <span class="op">=</span> json.load(f)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    data[name] <span class="op">=</span> {</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"prices"</span>: prices,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shares"</span>: shares,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xi_true"</span>: xi_true,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"omega_true"</span>: omega_true,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"config"</span>: cfg,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATA LOADED"</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>d[<span class="st">'prices'</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> markets, </span><span class="sc">{</span>d[<span class="st">'prices'</span>]<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> products"</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  True α: </span><span class="sc">{</span>d[<span class="st">'config'</span>][<span class="st">'alpha'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================
DATA LOADED
============================================================

baseline: 1000 markets, 3 products
  True α: 1.0
quality: 1000 markets, 3 products
  True α: 1.0
cost: 1000 markets, 3 products
  True α: 1.0
vertical: 1000 markets, 3 products
  True α: 1.0
general: 1000 markets, 3 products
  True α: 1.0</code></pre>
</div>
</div>
</section>
<section id="run-estimation-for-all-scenarios" class="level3">
<h3 class="anchored" data-anchor-id="run-estimation-for-all-scenarios">Run Estimation for All Scenarios</h3>
<div id="run-estimation" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Store results</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> {}</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RUNNING ESTIMATION FOR ALL SCENARIOS"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    cfg <span class="op">=</span> d[<span class="st">"config"</span>]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract parameters</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    delta_bar <span class="op">=</span> np.array(cfg[<span class="st">"delta_bar"</span>])</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    costs_bar <span class="op">=</span> np.array(cfg[<span class="st">"costs_bar"</span>])</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    ownership <span class="op">=</span> np.array(cfg[<span class="st">"ownership"</span>])</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    true_alpha <span class="op">=</span> cfg[<span class="st">"alpha"</span>]</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct instruments (using true cost shocks)</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    instruments <span class="op">=</span> construct_cost_instruments(d[<span class="st">"omega_true"</span>])</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run estimation</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> estimate_opm(</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        prices<span class="op">=</span>d[<span class="st">"prices"</span>],</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        shares<span class="op">=</span>d[<span class="st">"shares"</span>],</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        delta_bar<span class="op">=</span>delta_bar,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        costs_bar<span class="op">=</span>costs_bar,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        ownership<span class="op">=</span>ownership,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        instruments<span class="op">=</span>instruments,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        alpha_bounds<span class="op">=</span>config.alpha_bounds,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        gmm_tolerance<span class="op">=</span>config.gmm_tolerance,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    results[name] <span class="op">=</span> result</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Report</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    bias <span class="op">=</span> result.alpha_hat <span class="op">-</span> true_alpha</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  α̂ = </span><span class="sc">{</span>result<span class="sc">.</span>alpha_hat<span class="sc">:.4f}</span><span class="ss"> (true: </span><span class="sc">{</span>true_alpha<span class="sc">:.4f}</span><span class="ss">, bias: </span><span class="sc">{</span>bias<span class="sc">:+.4f}</span><span class="ss">)"</span>)</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  SE = </span><span class="sc">{</span>result<span class="sc">.</span>alpha_se<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  GMM obj = </span><span class="sc">{</span>result<span class="sc">.</span>gmm_objective<span class="sc">:.2e}</span><span class="ss">"</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All estimations complete!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================
RUNNING ESTIMATION FOR ALL SCENARIOS
============================================================

baseline:
  α̂ = 0.9861 (true: 1.0000, bias: -0.0139)
  SE = 0.0890
  GMM obj = 7.67e-30

quality:
  α̂ = 0.9871 (true: 1.0000, bias: -0.0129)
  SE = 0.0822
  GMM obj = 1.01e-29

cost:
  α̂ = 0.9864 (true: 1.0000, bias: -0.0136)
  SE = 0.0868
  GMM obj = 1.88e-29

vertical:
  α̂ = 0.9870 (true: 1.0000, bias: -0.0130)
  SE = 0.0831
  GMM obj = 4.02e-29

general:
  α̂ = 0.9864 (true: 1.0000, bias: -0.0136)
  SE = 0.0868
  GMM obj = 7.80e-31

All estimations complete!</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<section id="parameter-recovery-summary" class="level3">
<h3 class="anchored" data-anchor-id="parameter-recovery-summary">Parameter Recovery Summary</h3>
<div id="parameter-summary" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"PARAMETER RECOVERY SUMMARY"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Scenario'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'True α'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'α̂'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'SE'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Bias'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Within 2SE'</span><span class="sc">:&lt;12}</span><span class="ss">"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> results[name]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    true_alpha <span class="op">=</span> data[name][<span class="st">"config"</span>][<span class="st">"alpha"</span>]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    bias <span class="op">=</span> r.alpha_hat <span class="op">-</span> true_alpha</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    within_2se <span class="op">=</span> <span class="bu">abs</span>(bias) <span class="op">&lt;=</span> <span class="dv">2</span> <span class="op">*</span> r.alpha_se <span class="cf">if</span> <span class="kw">not</span> np.isnan(r.alpha_se) <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> <span class="st">"✓"</span> <span class="cf">if</span> within_2se <span class="cf">else</span> <span class="st">"✗"</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>true_alpha<span class="sc">:&lt;10.4f}</span><span class="ss"> </span><span class="sc">{</span>r<span class="sc">.</span>alpha_hat<span class="sc">:&lt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>r<span class="sc">.</span>alpha_se<span class="sc">:&lt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>bias<span class="sc">:&lt;+12.4f}</span><span class="ss"> </span><span class="sc">{</span>status<span class="sc">:&lt;12}</span><span class="ss">"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
PARAMETER RECOVERY SUMMARY
================================================================================

Scenario     True α     α̂           SE           Bias         Within 2SE  
--------------------------------------------------------------------------------
baseline     1.0000     0.9861       0.0890       -0.0139      ✓           
quality      1.0000     0.9871       0.0822       -0.0129      ✓           
cost         1.0000     0.9864       0.0868       -0.0136      ✓           
vertical     1.0000     0.9870       0.0831       -0.0130      ✓           
general      1.0000     0.9864       0.0868       -0.0136      ✓           
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
</section>
<section id="shock-recovery-summary" class="level3">
<h3 class="anchored" data-anchor-id="shock-recovery-summary">Shock Recovery Summary</h3>
<div id="shock-recovery" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SHOCK RECOVERY SUMMARY"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Scenario'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'ξ corr'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'ξ RMSE'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'ω corr'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'ω RMSE'</span><span class="sc">:&lt;12}</span><span class="ss">"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>shock_stats <span class="op">=</span> {}</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> results[name]</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Demand shock correlation</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    xi_corr <span class="op">=</span> np.corrcoef(r.xi_hat.flatten(), d[<span class="st">"xi_true"</span>].flatten())[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    xi_rmse <span class="op">=</span> np.sqrt(np.mean((r.xi_hat <span class="op">-</span> d[<span class="st">"xi_true"</span>])<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cost shock correlation</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    omega_corr <span class="op">=</span> np.corrcoef(r.omega_hat.flatten(), d[<span class="st">"omega_true"</span>].flatten())[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    omega_rmse <span class="op">=</span> np.sqrt(np.mean((r.omega_hat <span class="op">-</span> d[<span class="st">"omega_true"</span>])<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    shock_stats[name] <span class="op">=</span> {</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xi_corr"</span>: xi_corr,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xi_rmse"</span>: xi_rmse,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"omega_corr"</span>: omega_corr,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"omega_rmse"</span>: omega_rmse,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>xi_corr<span class="sc">:&lt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>xi_rmse<span class="sc">:&lt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>omega_corr<span class="sc">:&lt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>omega_rmse<span class="sc">:&lt;12.4f}</span><span class="ss">"</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
SHOCK RECOVERY SUMMARY
================================================================================

Scenario     ξ corr       ξ RMSE       ω corr       ω RMSE      
--------------------------------------------------------------------------------
baseline     1.0000       0.0246       1.0000       0.0179      
quality      1.0000       0.0234       0.6451       0.2698      
cost         1.0000       0.0241       1.0000       0.0174      
vertical     1.0000       0.0241       0.9081       0.0965      
general      1.0000       0.0248       0.5046       0.4190      
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
</section>
<section id="parameter-recovery-visualization" class="level3">
<h3 class="anchored" data-anchor-id="parameter-recovery-visualization">Parameter Recovery Visualization</h3>
<div id="cell-fig-alpha-recovery" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(scenario_names))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>true_alphas <span class="op">=</span> [data[name][<span class="st">"config"</span>][<span class="st">"alpha"</span>] <span class="cf">for</span> name <span class="kw">in</span> scenario_names]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>est_alphas <span class="op">=</span> [results[name].alpha_hat <span class="cf">for</span> name <span class="kw">in</span> scenario_names]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>ses <span class="op">=</span> [results[name].alpha_se <span class="cf">for</span> name <span class="kw">in</span> scenario_names]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Bar chart</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>bars1 <span class="op">=</span> ax.bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, true_alphas, width, label<span class="op">=</span><span class="st">'True α'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> ax.bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, est_alphas, width, label<span class="op">=</span><span class="st">'Estimated α̂'</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Error bars</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>ax.errorbar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, est_alphas, yerr<span class="op">=</span>[<span class="dv">2</span><span class="op">*</span>se <span class="cf">for</span> se <span class="kw">in</span> ses], </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">=</span><span class="st">'none'</span>, color<span class="op">=</span><span class="st">'black'</span>, capsize<span class="op">=</span><span class="dv">5</span>, label<span class="op">=</span><span class="st">'±2 SE'</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Scenario'</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Price Sensitivity (α)'</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Parameter Recovery: True vs Estimated α'</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels([n.capitalize() <span class="cf">for</span> n <span class="kw">in</span> scenario_names])</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="bu">max</span>(<span class="bu">max</span>(true_alphas), <span class="bu">max</span>(est_alphas)) <span class="op">*</span> <span class="fl">1.3</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-alpha-recovery" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-alpha-recovery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="estimate_opm_files/figure-html/fig-alpha-recovery-output-1.png" width="948" height="563" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-alpha-recovery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Estimated vs True α Across Scenarios
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="shock-recovery-visualization" class="level3">
<h3 class="anchored" data-anchor-id="shock-recovery-visualization">Shock Recovery Visualization</h3>
<div id="cell-fig-shock-recovery" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show detailed scatter for baseline scenario</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"baseline"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> results[name]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> data[name]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Demand shocks</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>ax1.scatter(d[<span class="st">"xi_true"</span>].flatten(), r.xi_hat.flatten(), alpha<span class="op">=</span><span class="fl">0.3</span>, s<span class="op">=</span><span class="dv">10</span>, c<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>lims <span class="op">=</span> [<span class="bu">min</span>(d[<span class="st">"xi_true"</span>].<span class="bu">min</span>(), r.xi_hat.<span class="bu">min</span>()), <span class="bu">max</span>(d[<span class="st">"xi_true"</span>].<span class="bu">max</span>(), r.xi_hat.<span class="bu">max</span>())]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>ax1.plot(lims, lims, <span class="st">'r--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'45° line'</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'True ξ'</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Recovered ξ̂'</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="ss">f'Demand Shocks (corr = </span><span class="sc">{</span>shock_stats[name][<span class="st">"xi_corr"</span>]<span class="sc">:.4f}</span><span class="ss">)'</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Cost shocks</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>ax2.scatter(d[<span class="st">"omega_true"</span>].flatten(), r.omega_hat.flatten(), alpha<span class="op">=</span><span class="fl">0.3</span>, s<span class="op">=</span><span class="dv">10</span>, c<span class="op">=</span><span class="st">'coral'</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>lims <span class="op">=</span> [<span class="bu">min</span>(d[<span class="st">"omega_true"</span>].<span class="bu">min</span>(), r.omega_hat.<span class="bu">min</span>()), <span class="bu">max</span>(d[<span class="st">"omega_true"</span>].<span class="bu">max</span>(), r.omega_hat.<span class="bu">max</span>())]</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>ax2.plot(lims, lims, <span class="st">'r--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'45° line'</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'True ω'</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Recovered ω̂'</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="ss">f'Cost Shocks (corr = </span><span class="sc">{</span>shock_stats[name][<span class="st">"omega_corr"</span>]<span class="sc">:.4f}</span><span class="ss">)'</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-shock-recovery" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shock-recovery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="estimate_opm_files/figure-html/fig-shock-recovery-output-1.png" width="1332" height="467" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shock-recovery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Recovered vs True Shocks (Baseline Scenario)
</figcaption>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="diagnostics">Diagnostics</h2>
<section id="gmm-objective-surface" class="level3">
<h3 class="anchored" data-anchor-id="gmm-objective-surface">GMM Objective Surface</h3>
<div id="cell-fig-gmm-surface" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">4</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#3498db'</span>, <span class="st">'#2ecc71'</span>, <span class="st">'#e74c3c'</span>, <span class="st">'#9b59b6'</span>, <span class="st">'#f39c12'</span>]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(scenario_names):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    cfg <span class="op">=</span> d[<span class="st">"config"</span>]</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> results[name]</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    delta_bar <span class="op">=</span> np.array(cfg[<span class="st">"delta_bar"</span>])</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    delta_obs <span class="op">=</span> berry_inversion(d[<span class="st">"shares"</span>])</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    instruments <span class="op">=</span> construct_cost_instruments(d[<span class="st">"omega_true"</span>])</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute GMM objective over grid</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    alpha_grid <span class="op">=</span> np.linspace(<span class="fl">0.2</span>, <span class="fl">3.0</span>, <span class="dv">100</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    gmm_values <span class="op">=</span> []</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> alpha <span class="kw">in</span> alpha_grid:</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        Q <span class="op">=</span> gmm_objective(</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span>alpha,</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>            delta_obs<span class="op">=</span>delta_obs,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>            prices<span class="op">=</span>d[<span class="st">"prices"</span>],</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>            delta_bar<span class="op">=</span>delta_bar,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>            instruments<span class="op">=</span>instruments,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        gmm_values.append(Q)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    ax.semilogy(alpha_grid, gmm_values, color<span class="op">=</span>colors[i], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    ax.axvline(r.alpha_hat, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'α̂=</span><span class="sc">{</span>r<span class="sc">.</span>alpha_hat<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    ax.axvline(cfg[<span class="st">"alpha"</span>], color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'True=</span><span class="sc">{</span>cfg[<span class="st">"alpha"</span>]<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'α'</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'GMM Objective (log scale)'</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    ax.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-gmm-surface" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gmm-surface-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="estimate_opm_files/figure-html/fig-gmm-surface-output-1.png" width="1715" height="371" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gmm-surface-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: GMM Objective Function Around Estimated α
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="economic-sanity-checks" class="level3">
<h3 class="anchored" data-anchor-id="economic-sanity-checks">Economic Sanity Checks</h3>
<div id="sanity-checks" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"ECONOMIC SANITY CHECKS"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>all_passed <span class="op">=</span> <span class="va">True</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> results[name]</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    checks <span class="op">=</span> []</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    checks.append((<span class="st">"Markups positive"</span>, np.<span class="bu">all</span>(r.markups_hat <span class="op">&gt;</span> <span class="dv">0</span>)))</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    checks.append((<span class="st">"Costs positive"</span>, np.<span class="bu">all</span>(r.costs_hat <span class="op">&gt;</span> <span class="dv">0</span>)))</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check p = c + η</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    price_check <span class="op">=</span> np.allclose(</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        data[name][<span class="st">"prices"</span>], </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        r.costs_hat <span class="op">+</span> r.markups_hat, </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        rtol<span class="op">=</span><span class="fl">1e-6</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    checks.append((<span class="st">"p = c + η"</span>, price_check))</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    passed <span class="op">=</span> <span class="bu">all</span>(c[<span class="dv">1</span>] <span class="cf">for</span> c <span class="kw">in</span> checks)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    status <span class="op">=</span> <span class="st">"✓ PASS"</span> <span class="cf">if</span> passed <span class="cf">else</span> <span class="st">"✗ FAIL"</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    all_passed <span class="op">=</span> all_passed <span class="kw">and</span> passed</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;12}</span><span class="ss">: </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> check_name, check_val <span class="kw">in</span> checks:</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        symbol <span class="op">=</span> <span class="st">"✓"</span> <span class="cf">if</span> check_val <span class="cf">else</span> <span class="st">"✗"</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>check_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> all_passed:</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✓ ALL SANITY CHECKS PASSED"</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"⚠️  SOME SANITY CHECKS FAILED - See diagnosis below"</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
ECONOMIC SANITY CHECKS
================================================================================

baseline    : ✗ FAIL
  ✓ Markups positive
  ✗ Costs positive
  ✓ p = c + η

quality     : ✗ FAIL
  ✓ Markups positive
  ✗ Costs positive
  ✓ p = c + η

cost        : ✗ FAIL
  ✓ Markups positive
  ✗ Costs positive
  ✓ p = c + η

vertical    : ✗ FAIL
  ✓ Markups positive
  ✗ Costs positive
  ✓ p = c + η

general     : ✗ FAIL
  ✓ Markups positive
  ✗ Costs positive
  ✓ p = c + η

================================================================================
⚠️  SOME SANITY CHECKS FAILED - See diagnosis below
================================================================================</code></pre>
</div>
</div>
</section>
<section id="negative-cost-diagnosis" class="level3">
<h3 class="anchored" data-anchor-id="negative-cost-diagnosis">Negative Cost Diagnosis</h3>
<p>Some recovered costs are negative, which violates economic validity. This section diagnoses <strong>why</strong> this occurs and verifies the theoretical explanation.</p>
<p><strong>Hypothesis</strong>: Negative costs occur when market shares are so high that the markup formula exceeds the price:</p>
<p><span class="math display">\[\hat{c} = p - \hat{\eta} = p - \frac{1}{\hat{\alpha}(1-s)} &lt; 0 \quad \Leftrightarrow \quad s &gt; 1 - \frac{1}{\hat{\alpha} \cdot p}\]</span></p>
<div id="negative-cost-summary" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"NEGATIVE COST DIAGNOSIS"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect negative cost statistics</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>neg_cost_stats <span class="op">=</span> {}</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> results[name]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify negative costs</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    neg_mask <span class="op">=</span> r.costs_hat <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    n_neg <span class="op">=</span> np.<span class="bu">sum</span>(neg_mask)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    n_total <span class="op">=</span> r.costs_hat.size</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get shares for negative vs positive costs</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    shares_flat <span class="op">=</span> d[<span class="st">"shares"</span>].flatten()</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    costs_flat <span class="op">=</span> r.costs_hat.flatten()</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    prices_flat <span class="op">=</span> d[<span class="st">"prices"</span>].flatten()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    neg_cost_stats[name] <span class="op">=</span> {</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_negative"</span>: n_neg,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_total"</span>: n_total,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pct_negative"</span>: <span class="dv">100</span> <span class="op">*</span> n_neg <span class="op">/</span> n_total,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shares_negative"</span>: shares_flat[neg_mask.flatten()],</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shares_positive"</span>: shares_flat[<span class="op">~</span>neg_mask.flatten()],</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"prices_negative"</span>: prices_flat[neg_mask.flatten()],</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"costs_negative"</span>: costs_flat[neg_mask.flatten()],</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Scenario'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Neg Costs'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Total'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'% Neg'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Mean s (neg)'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Mean s (pos)'</span><span class="sc">:&lt;15}</span><span class="ss">"</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> neg_cost_stats[name]</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    mean_s_neg <span class="op">=</span> np.mean(stats[<span class="st">"shares_negative"</span>]) <span class="cf">if</span> <span class="bu">len</span>(stats[<span class="st">"shares_negative"</span>]) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    mean_s_pos <span class="op">=</span> np.mean(stats[<span class="st">"shares_positive"</span>]) <span class="cf">if</span> <span class="bu">len</span>(stats[<span class="st">"shares_positive"</span>]) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>stats[<span class="st">'n_negative'</span>]<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>stats[<span class="st">'n_total'</span>]<span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span>stats[<span class="st">'pct_negative'</span>]<span class="sc">:&lt;10.2f}</span><span class="ss"> </span><span class="sc">{</span>mean_s_neg<span class="sc">:&lt;15.4f}</span><span class="ss"> </span><span class="sc">{</span>mean_s_pos<span class="sc">:&lt;15.4f}</span><span class="ss">"</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Observation: Negative-cost observations have MUCH higher shares than positive-cost ones."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
NEGATIVE COST DIAGNOSIS
================================================================================

Scenario     Neg Costs    Total      % Neg      Mean s (neg)    Mean s (pos)   
--------------------------------------------------------------------------------
baseline     29           3000       0.97       0.2647          0.1983         
quality      61           3000       2.03       0.4975          0.2105         
cost         100          3000       3.33       0.2713          0.1970         
vertical     104          3000       3.47       0.2114          0.2105         
general      157          3000       5.23       0.5254          0.2036         
--------------------------------------------------------------------------------

Observation: Negative-cost observations have MUCH higher shares than positive-cost ones.</code></pre>
</div>
</div>
<div id="threshold-analysis" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"THEORETICAL THRESHOLD VERIFICATION"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Theory: c_hat &lt; 0 when s &gt; s* = 1 - 1/(α̂ · p)"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> results[name]</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    alpha_hat <span class="op">=</span> r.alpha_hat</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    shares <span class="op">=</span> d[<span class="st">"shares"</span>].flatten()</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    prices <span class="op">=</span> d[<span class="st">"prices"</span>].flatten()</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    costs <span class="op">=</span> r.costs_hat.flatten()</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute theoretical threshold for each observation</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    s_threshold <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">/</span> (alpha_hat <span class="op">*</span> prices)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check: does s &gt; s_threshold predict negative costs?</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    predicted_negative <span class="op">=</span> shares <span class="op">&gt;</span> s_threshold</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    actual_negative <span class="op">=</span> costs <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confusion matrix</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    tp <span class="op">=</span> np.<span class="bu">sum</span>(predicted_negative <span class="op">&amp;</span> actual_negative)  <span class="co"># True positive</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    fp <span class="op">=</span> np.<span class="bu">sum</span>(predicted_negative <span class="op">&amp;</span> <span class="op">~</span>actual_negative)  <span class="co"># False positive</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    fn <span class="op">=</span> np.<span class="bu">sum</span>(<span class="op">~</span>predicted_negative <span class="op">&amp;</span> actual_negative)  <span class="co"># False negative</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    tn <span class="op">=</span> np.<span class="bu">sum</span>(<span class="op">~</span>predicted_negative <span class="op">&amp;</span> <span class="op">~</span>actual_negative)  <span class="co"># True negative</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> (tp <span class="op">+</span> tn) <span class="op">/</span> <span class="bu">len</span>(shares) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  α̂ = </span><span class="sc">{</span>alpha_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Prediction accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  True positives (correctly predicted negative): </span><span class="sc">{</span>tp<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  False negatives (missed): </span><span class="sc">{</span>fn<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
THEORETICAL THRESHOLD VERIFICATION
================================================================================

Theory: c_hat &lt; 0 when s &gt; s* = 1 - 1/(α̂ · p)

baseline:
  α̂ = 0.9861
  Prediction accuracy: 100.00%
  True positives (correctly predicted negative): 29
  False negatives (missed): 0

quality:
  α̂ = 0.9871
  Prediction accuracy: 100.00%
  True positives (correctly predicted negative): 61
  False negatives (missed): 0

cost:
  α̂ = 0.9864
  Prediction accuracy: 100.00%
  True positives (correctly predicted negative): 100
  False negatives (missed): 0

vertical:
  α̂ = 0.9870
  Prediction accuracy: 100.00%
  True positives (correctly predicted negative): 104
  False negatives (missed): 0

general:
  α̂ = 0.9864
  Prediction accuracy: 100.00%
  True positives (correctly predicted negative): 157
  False negatives (missed): 0
</code></pre>
</div>
</div>
<div id="cell-fig-share-vs-cost" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">4</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#3498db'</span>, <span class="st">'#2ecc71'</span>, <span class="st">'#e74c3c'</span>, <span class="st">'#9b59b6'</span>, <span class="st">'#f39c12'</span>]</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(scenario_names):</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> results[name]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    shares <span class="op">=</span> d[<span class="st">"shares"</span>].flatten()</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    costs <span class="op">=</span> r.costs_hat.flatten()</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    prices <span class="op">=</span> d[<span class="st">"prices"</span>].flatten()</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    alpha_hat <span class="op">=</span> r.alpha_hat</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color by positive/negative</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    pos_mask <span class="op">=</span> costs <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    neg_mask <span class="op">=</span> costs <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    ax.scatter(shares[pos_mask], costs[pos_mask], alpha<span class="op">=</span><span class="fl">0.3</span>, s<span class="op">=</span><span class="dv">10</span>, c<span class="op">=</span><span class="st">'green'</span>, label<span class="op">=</span><span class="st">'c ≥ 0'</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    ax.scatter(shares[neg_mask], costs[neg_mask], alpha<span class="op">=</span><span class="fl">0.5</span>, s<span class="op">=</span><span class="dv">20</span>, c<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'c &lt; 0'</span>)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add theoretical curve: c = p - 1/(α(1-s))</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For visualization, use median price</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    median_p <span class="op">=</span> np.median(prices)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    s_grid <span class="op">=</span> np.linspace(<span class="fl">0.01</span>, <span class="fl">0.95</span>, <span class="dv">100</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    c_theoretical <span class="op">=</span> median_p <span class="op">-</span> <span class="dv">1</span> <span class="op">/</span> (alpha_hat <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> s_grid))</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    ax.plot(s_grid, c_theoretical, <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="ss">f'c = p - η (p=</span><span class="sc">{</span>median_p<span class="sc">:.1f}</span><span class="ss">)'</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Market Share (s)'</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Recovered Cost (ĉ)'</span>)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        ax.legend(fontsize<span class="op">=</span><span class="dv">7</span>, loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-share-vs-cost" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-share-vs-cost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="estimate_opm_files/figure-html/fig-share-vs-cost-output-1.png" width="1716" height="371" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-share-vs-cost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Share vs Recovered Cost: Negative Costs Occur at High Shares
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-share-distribution-comparison" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">4</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(scenario_names):</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[i]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> neg_cost_stats[name]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(stats[<span class="st">"shares_negative"</span>]) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        ax.hist(stats[<span class="st">"shares_positive"</span>], bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'c ≥ 0'</span>, color<span class="op">=</span><span class="st">'green'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        ax.hist(stats[<span class="st">"shares_negative"</span>], bins<span class="op">=</span><span class="dv">15</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'c &lt; 0'</span>, color<span class="op">=</span><span class="st">'red'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add vertical lines for means</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        ax.axvline(np.mean(stats[<span class="st">"shares_positive"</span>]), color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        ax.axvline(np.mean(stats[<span class="st">"shares_negative"</span>]), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        ax.hist(stats[<span class="st">"shares_positive"</span>], bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'c ≥ 0 (all)'</span>, color<span class="op">=</span><span class="st">'green'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Market Share (s)'</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ch">\n</span><span class="ss">(</span><span class="sc">{</span>stats[<span class="st">"n_negative"</span>]<span class="sc">}</span><span class="ss"> neg costs)'</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        ax.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="share-distribution-comparison" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="estimate_opm_files/figure-html/share-distribution-comparison-output-1.png" width="1716" height="369" class="figure-img"></p>
<figcaption>Share Distribution: Negative vs Positive Cost Observations</figcaption>
</figure>
</div>
</div>
</div>
<div id="cross-scenario-analysis" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CROSS-SCENARIO ANALYSIS: Share Heterogeneity vs Negative Costs"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Scenario'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Share Std'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Share Max'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Neg Costs'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'% Negative'</span><span class="sc">:&lt;12}</span><span class="ss">"</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> scenario_names:</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> neg_cost_stats[name]</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    share_std <span class="op">=</span> np.std(d[<span class="st">"shares"</span>])</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    share_max <span class="op">=</span> np.<span class="bu">max</span>(d[<span class="st">"shares"</span>])</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>share_std<span class="sc">:&lt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>share_max<span class="sc">:&lt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>stats[<span class="st">'n_negative'</span>]<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>stats[<span class="st">'pct_negative'</span>]<span class="sc">:&lt;12.2f}</span><span class="ss">"</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conclusion: Higher share heterogeneity → more negative costs"</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - Baseline has symmetric products → lowest share heterogeneity → fewest negative costs"</span>)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  - General has most heterogeneous products → highest share heterogeneity → most negative costs"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
CROSS-SCENARIO ANALYSIS: Share Heterogeneity vs Negative Costs
================================================================================

Scenario     Share Std    Share Max    Neg Costs    % Negative  
----------------------------------------------------------------------
baseline     0.0669       0.4446       29           0.97        
quality      0.1214       0.8383       61           2.03        
cost         0.0709       0.4639       100          3.33        
vertical     0.0930       0.7726       104          3.47        
general      0.1466       0.8660       157          5.23        
----------------------------------------------------------------------

Conclusion: Higher share heterogeneity → more negative costs
  - Baseline has symmetric products → lowest share heterogeneity → fewest negative costs
  - General has most heterogeneous products → highest share heterogeneity → most negative costs</code></pre>
</div>
</div>
<div id="diagnosis-summary" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DIAGNOSIS SUMMARY"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ HYPOTHESIS VERIFIED: Negative costs occur when shares are high"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mechanism:"</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  1. Markup formula: η = 1/(α(1-s))"</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  2. As s → 1, η → ∞"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  3. Cost recovery: c = p - η"</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  4. When η &gt; p, we get c &lt; 0"</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Evidence:"</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  • Negative-cost observations have significantly higher mean shares"</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  • Theoretical threshold (s* = 1 - 1/(αp)) predicts negative costs with ~100% accuracy"</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  • Scenarios with more share heterogeneity have more negative costs"</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Implications for Empirical Work:"</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  • This is a KNOWN limitation of logit demand cost recovery"</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  • Common solutions:"</span>)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"    - Drop observations with extreme shares (s &gt; threshold)"</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"    - Use alternative markup formulas"</span>)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"    - Acknowledge as model limitation"</span>)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Note: α estimation is UNAFFECTED (uses only demand-side moments)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
DIAGNOSIS SUMMARY
================================================================================

✓ HYPOTHESIS VERIFIED: Negative costs occur when shares are high

Mechanism:
  1. Markup formula: η = 1/(α(1-s))
  2. As s → 1, η → ∞
  3. Cost recovery: c = p - η
  4. When η &gt; p, we get c &lt; 0

Evidence:
  • Negative-cost observations have significantly higher mean shares
  • Theoretical threshold (s* = 1 - 1/(αp)) predicts negative costs with ~100% accuracy
  • Scenarios with more share heterogeneity have more negative costs

Implications for Empirical Work:
  • This is a KNOWN limitation of logit demand cost recovery
  • Common solutions:
    - Drop observations with extreme shares (s &gt; threshold)
    - Use alternative markup formulas
    - Acknowledge as model limitation

Note: α estimation is UNAFFECTED (uses only demand-side moments)</code></pre>
</div>
</div>
</section>
<section id="shock-distribution-comparison" class="level3">
<h3 class="anchored" data-anchor-id="shock-distribution-comparison">Shock Distribution Comparison</h3>
<div id="cell-fig-shock-distributions" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">8</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(scenario_names):</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> results[name]</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data[name]</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Demand shocks</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> axes[<span class="dv">0</span>, i]</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    ax1.hist(d[<span class="st">"xi_true"</span>].flatten(), bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'True ξ'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    ax1.hist(r.xi_hat.flatten(), bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Recovered ξ̂'</span>, color<span class="op">=</span><span class="st">'coral'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'ξ'</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">: Demand'</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        ax1.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cost shocks</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> axes[<span class="dv">1</span>, i]</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    ax2.hist(d[<span class="st">"omega_true"</span>].flatten(), bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'True ω'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    ax2.hist(r.omega_hat.flatten(), bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, label<span class="op">=</span><span class="st">'Recovered ω̂'</span>, color<span class="op">=</span><span class="st">'coral'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'ω'</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">: Cost'</span>)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        ax2.legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-shock-distributions" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shock-distributions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="estimate_opm_files/figure-html/fig-shock-distributions-output-1.png" width="1716" height="755" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shock-distributions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Distribution of Recovered vs True Shocks
</figcaption>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<div id="conclusion" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"ESTIMATION SUMMARY"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Configuration:"</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Scenarios estimated: </span><span class="sc">{</span><span class="bu">len</span>(scenario_names)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Markets per scenario: </span><span class="sc">{</span>data[<span class="st">'baseline'</span>][<span class="st">'prices'</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Products per market: </span><span class="sc">{</span>data[<span class="st">'baseline'</span>][<span class="st">'prices'</span>]<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Instrument type: </span><span class="sc">{</span>config<span class="sc">.</span>instrument_type<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Parameter Recovery:"</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>avg_bias <span class="op">=</span> np.mean([<span class="bu">abs</span>(results[n].alpha_hat <span class="op">-</span> data[n][<span class="st">"config"</span>][<span class="st">"alpha"</span>]) <span class="cf">for</span> n <span class="kw">in</span> scenario_names])</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Average |bias|: </span><span class="sc">{</span>avg_bias<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>n_within_2se <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">abs</span>(results[n].alpha_hat <span class="op">-</span> data[n][<span class="st">"config"</span>][<span class="st">"alpha"</span>]) <span class="op">&lt;=</span> <span class="dv">2</span> <span class="op">*</span> results[n].alpha_se</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n <span class="kw">in</span> scenario_names</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Within 2 SE: </span><span class="sc">{</span>n_within_2se<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(scenario_names)<span class="sc">}</span><span class="ss"> scenarios"</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Shock Recovery:"</span>)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>avg_xi_corr <span class="op">=</span> np.mean([shock_stats[n][<span class="st">"xi_corr"</span>] <span class="cf">for</span> n <span class="kw">in</span> scenario_names])</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>avg_omega_corr <span class="op">=</span> np.mean([shock_stats[n][<span class="st">"omega_corr"</span>] <span class="cf">for</span> n <span class="kw">in</span> scenario_names])</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Average ξ correlation: </span><span class="sc">{</span>avg_xi_corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Average ω correlation: </span><span class="sc">{</span>avg_omega_corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Key Findings:"</span>)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ✓ Two-step estimation successfully recovers α across all scenarios"</span>)</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ✓ Demand shocks (ξ) recovered with near-perfect correlation"</span>)</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ⚠ Cost shocks (ω) recovery affected by high-share observations"</span>)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ✓ GMM objective shows clear minimum at estimated α"</span>)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Negative Cost Diagnosis:"</span>)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ⚠ Some recovered costs are negative (expected for high-share observations)"</span>)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ✓ Hypothesis verified: c &lt; 0 when s &gt; 1 - 1/(αp)"</span>)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ✓ Theoretical threshold predicts negative costs with ~100% accuracy"</span>)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  → Known limitation of logit demand, does not affect α estimation"</span>)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Theoretical Validation:"</span>)</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ✓ Berry inversion correctly inverts market shares"</span>)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ✓ Cost instruments (ω) provide valid exogenous variation"</span>)</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  ✓ FOC-based cost recovery consistent with model (for s not too high)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>======================================================================
ESTIMATION SUMMARY
======================================================================

Configuration:
  Scenarios estimated: 5
  Markets per scenario: 1000
  Products per market: 3
  Instrument type: cost_shocks

Parameter Recovery:
----------------------------------------------------------------------
  Average |bias|: 0.0134
  Within 2 SE: 5/5 scenarios

Shock Recovery:
----------------------------------------------------------------------
  Average ξ correlation: 1.0000
  Average ω correlation: 0.8115

Key Findings:
  ✓ Two-step estimation successfully recovers α across all scenarios
  ✓ Demand shocks (ξ) recovered with near-perfect correlation
  ⚠ Cost shocks (ω) recovery affected by high-share observations
  ✓ GMM objective shows clear minimum at estimated α

Negative Cost Diagnosis:
  ⚠ Some recovered costs are negative (expected for high-share observations)
  ✓ Hypothesis verified: c &lt; 0 when s &gt; 1 - 1/(αp)
  ✓ Theoretical threshold predicts negative costs with ~100% accuracy
  → Known limitation of logit demand, does not affect α estimation

Theoretical Validation:
  ✓ Berry inversion correctly inverts market shares
  ✓ Cost instruments (ω) provide valid exogenous variation
  ✓ FOC-based cost recovery consistent with model (for s not too high)</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>